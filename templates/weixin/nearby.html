{% extends "weixin/base.html" %}
{% load static %}
{% block title %}茄子自拍{% endblock %}
{% block head %}

    <style type="text/css">
    .amap-logo {
            display: none;
     }
   .amap-copyright {
          bottom:-100px;
           display: none;
    }

    .cabinet_info{
        display: none;
    }
</style>

{% endblock %}

{% block content %}
    <div class="dt_con" id="container"></div>

    <div class="dt_hd">
      <div class="dt_hd_con" onclick="goto_location()">
          <div class="dt_hd_con_t"><img class="img_loca" src="/static/images/location.png" ></div>
          <div class="dt_hd_con_w">当前位置</div>
      </div>

    </div>
    <div class="cabinet_info">

    </div>


    <script src="/static/js/jquery-3.2.1.js"></script>
    <script src="/static/js/relalive.js"></script>
    {% ifequal is_weixin True %}
        <script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp"></script>
    {% else %}
        <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=b592c79c6b67ba952132ac8d517706f8"></script>
        <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    {% endifequal %}
    <script>
        window.onload = function(){
            //初始化地图函数  自定义函数名init
            var is_weixin = '{{ is_weixin }}';

            function init() {
                if(is_weixin === 'True')
                {
                    //定义map变量 调用 qq.maps.Map() 构造函数   获取地图显示容器
                     var map = new qq.maps.Map(document.getElementById("container"), {
                         center: new qq.maps.LatLng({{ lat }},{{ lon }}),      // 地图的中心地理坐标。
                         disableDefaultUI: true,
                         zoom:13
                    });

                     qq.maps.event.addListener(map,"click",function(){
                        $('.cabinet_info').hide();
                    });


                     {% for cabinet in cabinets %}
                        var lat = {{ cabinet.6 }};
                        var lon = {{ cabinet.7 }};
                        var tmp_point = new qq.maps.LatLng(lat,lon);
                        addMarker(map, tmp_point, '{{ cabinet.0 }}');
                    {% endfor %}

                }
                else
                {
                    var map = new AMap.Map('container',{
                        resizeEnable: true,
                        zoom: 16,
                        center: [{{ lon }},{{ lat }}]
                    });
                    var toolBar;
                    map.plugin(["AMap.ToolBar"],function(){   //在地图中添加ToolBar插件
                        toolBar = new AMap.ToolBar();
                        map.addControl(toolBar);
                    });

                    {% for cabinet in cabinets %}
                        var lat = {{ cabinet.6 }};
                        var lon = {{ cabinet.7 }};
                        addMarker_zhifubao(map, lat, lon, '{{ cabinet.0 }}');
                    {% endfor %}
                }


            }

            //调用初始化函数地图
            init();
        };
        
        function addMarker(map, point, cabinet_id) {


            var anchor = new qq.maps.Point(3, -30),
            size = new qq.maps.Size(42, 11),
            origin = new qq.maps.Point(0, 0),
            icon = new qq.maps.MarkerImage('/static/images/weixin/weizhi.png', size, origin, anchor);
            var marker = new qq.maps.Marker({
                icon: icon,
                position: point,
                map: map
            });


            qq.maps.event.addListener(marker,"click",function(){
                $('.cabinet_info').show();
                get_attribute(cabinet_id);
            });
        }

        function addMarker_zhifubao(map, lat, lon, cabinet_id) {
            var marker = new AMap.Marker({
                position: [lon, lat],
                title: cabinet_id,
                map: map
            });
            AMap.event.addListener(marker, 'click', function () {
                get_attribute(cabinet_id);
            });
        }

        function get_attribute(cabinet_id) {
            $.ajax({
                type:"post",
                url:"/weixin/get_cabinet_info/",//自己填写请求地址
                data:{cabinet_id:cabinet_id},
                success:function(result){
                    $('.cabinet_info').html(result);
                }
            });
        }

        function goto_location() {
            location.href = '/weixin/nearby/'
        }

    </script>

{% endblock %}